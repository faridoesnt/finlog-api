name: Deploy Prod

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    environment: prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate runtime env file
        run: |
          cat <<EOF > .env.runtime
          SERVER_ENV="${{ vars.SERVER_ENV }}"
          SERVER_PORT="${{ vars.SERVER_PORT }}"

          DB_DIALEG="${{ vars.DB_DIALEG }}"
          DB_HOSTWRITER="${{ vars.DB_HOSTWRITER }}"
          DB_HOSTREADER="${{ vars.DB_HOSTREADER }}"
          DB_PORT="${{ vars.DB_PORT }}"
          DB_NAME="${{ secrets.DB_NAME }}"
          USERNAME="${{ secrets.USERNAME }}"
          PASSWORD="${{ secrets.PASSWORD }}"

          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          REFRESH_SECRET="${{ secrets.REFRESH_SECRET }}"
          JWT_TTL="${{ vars.JWT_TTL }}"
          REFRESH_TTL="${{ vars.REFRESH_TTL }}"

          RATE_LIMIT_REQUESTS="${{ vars.RATE_LIMIT_REQUESTS }}"
          RATE_LIMIT_WINDOW="${{ vars.RATE_LIMIT_WINDOW }}"
          IMPORT_RATE_LIMIT_BATCHES="${{ vars.IMPORT_RATE_LIMIT_BATCHES }}"
          IMPORT_RATE_LIMIT_WINDOW="${{ vars.IMPORT_RATE_LIMIT_WINDOW }}"
          IMPORT_UNDO_RATE_LIMIT_REQUESTS="${{ vars.IMPORT_UNDO_RATE_LIMIT_REQUESTS }}"
          IMPORT_UNDO_RATE_LIMIT_WINDOW="${{ vars.IMPORT_UNDO_RATE_LIMIT_WINDOW }}"

          API_BASE_URL="${{ vars.API_BASE_URL }}"

          RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
          EMAIL_FROM="${{ vars.EMAIL_FROM }}"
          RESEND_WEBHOOK_SECRET="${{ secrets.RESEND_WEBHOOK_SECRET }}"

          MYSQL_ROOT_PASSWORD="${{ secrets.MYSQL_ROOT_PASSWORD }}"
          MYSQL_DATABASE="${{ secrets.MYSQL_DATABASE }}"
          MYSQL_USER="${{ secrets.MYSQL_USER }}"
          MYSQL_PASSWORD="${{ secrets.MYSQL_PASSWORD }}"

          API_DOMAIN="${{ vars.API_DOMAIN }}"
          WEB_DOMAIN="${{ vars.WEB_DOMAIN }}"

          NETDATA_MYSQL_USER="${{ secrets.NETDATA_MYSQL_USER }}"
          NETDATA_MYSQL_PASSWORD="${{ secrets.NETDATA_MYSQL_PASSWORD }}"
          EOF

      - name: Upload Code to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "."
          target: "/home/farid/apps/finlog-api"
          rm: false
          overwrite: true

      - name: Blue-Green Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd /home/farid/apps/finlog-api

            test -f .env.runtime || { echo "âŒ .env.runtime missing"; exit 1; }
            chmod 600 .env.runtime

            set -a
            source .env.runtime
            set +a

            NETWORK="finlog-api_finlog-net"

            echo "ğŸ” Checking Blue/Green existence..."
            BLUE_EXISTS=$(docker ps -a --format '{{.Names}}' | grep -w finlog-api-blue || true)
            GREEN_EXISTS=$(docker ps -a --format '{{.Names}}' | grep -w finlog-api-green || true)

            # =====================================
            # AUTO BOOTSTRAP (FIRST TIME ONLY)
            # =====================================
            if [ -z "$BLUE_EXISTS" ] && [ -z "$GREEN_EXISTS" ]; then
              echo "ğŸŸ¡ No blue/green found â€” BOOTSTRAPPING..."

              docker compose down || true

              echo "ğŸŸ¡ Building FIRST version as BLUE..."
              docker build -t finlog-api:blue .

              echo "ğŸŸ¡ Starting base infra (db, netdata, caddy)..."
              docker compose up -d db netdata caddy || true

              echo "ğŸ”µ Starting BLUE container..."
              docker compose up -d api-blue

              echo "â³ Waiting for BLUE health..."
              for i in {1..15}; do
                STATUS=$(docker inspect --format='{{json .State.Health.Status}}' finlog-api-blue | tr -d '"')
                echo "BLUE health: $STATUS"
                [ "$STATUS" = "healthy" ] && break
                sleep 2
              done

              if [ "$STATUS" != "healthy" ]; then
                echo "âŒ BOOTSTRAP FAILED â€” BLUE unhealthy"
                docker logs finlog-api-blue --tail 200
                exit 1
              fi

              echo "ğŸ”— Adding LIVE alias to BLUE..."
              docker network disconnect $NETWORK finlog-api-blue 2>/dev/null || true
              docker network connect --alias finlog-api-live $NETWORK finlog-api-blue

              echo "ğŸ‰ BOOTSTRAP COMPLETE â€” system ready!"
              exit 0
            fi

            # ======================================================
            # NORMAL BLUE-GREEN DEPLOY (AFTER BOOTSTRAP)
            # ======================================================
            echo "ğŸ”µ Detecting active color..."
            ACTIVE="none"

            if docker network inspect $NETWORK | grep -qw finlog-api-blue; then
              ACTIVE="blue"
            elif docker network inspect $NETWORK | grep -qw finlog-api-green; then
              ACTIVE="green"
            fi

            echo "Active color = $ACTIVE"

            if [ "$ACTIVE" = "blue" ]; then
              NEXT="green"
            else
              NEXT="blue"
            fi

            echo "Next deploy target = $NEXT"

            echo "ğŸ”µ Building NEXT image: finlog-api:$NEXT ..."
            docker build -t finlog-api:$NEXT .

            echo "ğŸ”µ Starting NEXT container..."
            docker compose up -d api-$NEXT

            echo "â³ Waiting for NEXT health..."
            for i in {1..15}; do
              STATUS=$(docker inspect --format='{{json .State.Health.Status}}' finlog-api-$NEXT | tr -d '"')
              echo "$NEXT health: $STATUS"
              [ "$STATUS" = "healthy" ] && break
              sleep 2
            done

            if [ "$STATUS" != "healthy" ]; then
              echo "âŒ NEXT unhealthy â€” rollback"
              docker rm -f finlog-api-$NEXT
              exit 1
            fi

            echo "ğŸ”„ Switching LIVE alias to $NEXT..."
            # FIX: disconnect alias only if exists
            docker network disconnect $NETWORK finlog-api-live 2>/dev/null || true

            # FIX: ensure target container is not already attached with a conflicting endpoint
            docker network disconnect $NETWORK finlog-api-$NEXT 2>/dev/null || true

            # NOW attach as alias cleanly
            docker network connect --alias finlog-api-live $NETWORK finlog-api-$NEXT

            echo "ğŸ’€ Stopping old $ACTIVE..."
            docker rm -f finlog-api-$ACTIVE || true

            echo "ğŸš€ Deployment complete â€” LIVE = $NEXT"

      - name: Recreate Netdata (force entrypoint)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd /home/farid/apps/finlog-api

            test -f .env.runtime || { echo "âŒ .env.runtime missing"; exit 1; }
            chmod 600 .env.runtime

            set -a
            source .env.runtime
            set +a
            
            echo "ğŸ”„ Rebuilding Netdata dengan konfigurasi baru..."
            docker compose build netdata --no-cache
            
            echo "ğŸ”„ Recreating Netdata..."
            docker compose up -d netdata --force-recreate
            
            echo "â³ Waiting 20s for Netdata to fully start..."
            sleep 20
            
            echo "ğŸ” Checking Netdata status..."
            docker exec finlog-netdata netdatacli ping && echo "âœ… Netdata running"
            
            echo "ğŸ” Checking enabled plugins..."
            docker exec finlog-netdata netdatacli list-collectors | grep -E "(cgroups|mysql|docker)" || true
            
            echo "ğŸ” Checking mysql.conf..."
            if docker exec finlog-netdata test -f /etc/netdata/go.d/mysql.conf; then
                echo "âœ… mysql.conf found"
                echo "ğŸ“„ mysql.conf content (masked):"
                docker exec finlog-netdata cat /etc/netdata/go.d/mysql.conf \
                  | sed -E 's/(password:).*/\1 ****/' \
                  | sed -E 's/(dsn:.*):(.*)@/\1:****@/'
            else
                echo "âŒ mysql.conf missing!"
                docker exec finlog-netdata ls -la /etc/netdata/go.d/
            fi
            
            echo "ğŸ” Checking if cgroups plugin is active..."
            curl -s http://localhost:19999/api/v1/charts | jq '.charts | keys[]' | grep cgroup && echo "âœ… cgroups monitoring ACTIVE!" || echo "âŒ cgroups not found"
            
            echo "ğŸ” Checking MySQL chart..."
            curl -s http://localhost:19999/api/v1/charts | jq '.charts | keys[]' | grep mysql && echo "âœ… MySQL monitoring ACTIVE!" || echo "âŒ MySQL not found"
            
            echo "ğŸ” Checking Docker chart..."
            curl -s http://localhost:19999/api/v1/charts | jq '.charts | keys[]' | grep docker && echo "âœ… Docker monitoring ACTIVE!" || echo "âŒ Docker not found"